---
layout: post
title: 如何避免表单的重复提交
date: 2016-06-16
categories: http协议
tags: [http]
description: 
---

### 一. 表单的重复提交问题

什么是表单的重复提交：在网速比较慢的情况下，用户提交表单之后，发现服务器半天没有响应，那么用户可能就会以为自己没有提交表单，就会再次点击按钮重复提交表单。

**三种重复提交表单的场景：**

- 网络很慢时，用户多次点击提交按钮

- 表单提交之后，用户点击刷新按钮

- 表单提交之后，用户后退到表单页面再次提交

### 二. 避免重复提交的方法

#### 1. 针对场景一：网络慢，用户多次点击submit按钮

在客户端利用js的方法：

**(1)用一个变量来标识表单是否已经提交**

```js
<!DOCTYPE HTML>
 <html>
   <head>
     <title>Form表单</title>
         <script type="text/javascript">
           var submitFlag = false;//表单是否已经提交标识，默认为false
           function dosubmit(){
              if(submitFlag == false){
                 submitFlag = true;//提交表单后，将表单是否已经提交标识设置为true
                 return true;//返回true让表单正常提交
	          }else{
	             return false;//返回false那么表单将不提交
	          }
            }
     	</script>
   </head>
   
   <body>
       <form onsubmit="return dosubmit()" method="post">
          用户名：
          <input type="text" name="username">
          <input type="submit" value="提交" id="submit">
       </form>
   </body>
 </html>
```

这种方法适用于用户点击按钮提交表单（这种方式会触发表单的`onsubmit()`事件）

**(2)在第一次提交表单后禁用该按钮**

**首先**，前端应该对用户所有的输入进行判断，验证通过之后允许用户做提交处理；

**然后**，第一次提交之后，将按钮的disabled属性置为disabled

    <input disabled="disabled">
	<button disabled="disabled">

同时，在向后台发送http请求时，前端页面添加一个div，显示正在加载中；当请求成功时，将这个div隐藏掉。

<font color="red">这种解决办法的缺点：不能屏蔽**回车键**触发的提交请求！！！</font>

#### 2. 针对场景二和场景三的问题

在服务器端使用**令牌机制（Token）**解决:

> 首先，当表单页面向服务器发起请求时，在服务器端生成一个Token(令牌)————唯一的随机标识号，用来标识这个用户。

> 在当前用户的Session域中保存这个Token，同时在请求被响应时，表单页面发送给浏览器，将Token写入表单中的隐藏字段（用表单中的隐藏域来保存这个Token值）。

> 然后，用户录入信息后点击提交。

> 用户提交表单时，会将这个Token一起提交到服务器端。

> 在服务器端判断客户端提交上来的Token与服务器端生成的Token是否一致。

> **如果相同**，则处理表单提交，处理完后清除当前用户的Session域中存储的Token。

> **如果服务器中的session中不存在这个Token**，那就是重复提交了，此时服务器端就可以不处理重复提交的表单。

场景二，表单提交之后，用户点击刷新按钮，会重新发起HTTP请求，这时页面中的表单隐藏域已经有Token值，这时服务器中的session中的Token已经被删掉了（由于已经提交了一次），所以服务器不会处理第二次提交的表单数据。

场景三，表单提交之后，用户回退到表单页面，再次提交表单，这种情况下回退到表单页面是不会重新发起HTTP请求的，访问的是浏览器中缓存的页面，因此，表单的Token值还是之前那个，这时服务器中的session中的Token已经被删掉了（由于已经提交了一次），所以服务器不会处理第二次提交的表单数据。

**什么是表单的隐藏域？**

指的是在form内声明一个type类型为hidden的input，使用value的属性值来存取数据。
```js
<input type="hidden" name="field＿name" value="value">
```

### <font color="red">扩展的小知识：</font>
 
验证码的原理与上面的令牌机制类似。

**1. 什么是验证码**

> 验证码一般是一串随机产生的数字或者符号，生成一副图片，图片里面加上一些干扰元素，由用户肉眼识别其中的验证码信息，然后输入表单提交网站验证，验证成功后才能使用某种功能。

**2. 验证码的作用**

用来区别计算机和人类。

**3. 验证原理及流程**

    服务器生产验证码
    
    发送给客户端
    
    在客户端显示
    
    用户根据显示输入验证码
    
    提交表单数据信息
    
    服务器根据提交的验证码信息和服务器端保存的字符是否相同
    
    如果相同，则通过验证
    
    如果不相同，则提示没有通过验证信息

